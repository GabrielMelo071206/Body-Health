document.addEventListener('DOMContentLoaded', function() {
    const planoNomeElement = document.getElementById('plano-nome');
    const planoPrecoElement = document.getElementById('plano-preco');
    const totalPrecoElement = document.getElementById('total-preco');
    const planTypeRadios = document.querySelectorAll('input[name="planType"]');
    const paymentTabButtons = document.querySelectorAll('.payment-tab-button');
    const paymentContents = document.querySelectorAll('.payment-content');

    const precoMensal = 19.90;
    const precoAnual = 179.90;

    // --- Lógica de seleção de plano ---
    function updatePlanDetails() {
        let selectedPlanType = document.querySelector('input[name="planType"]:checked').value;
        let currentPrice = 0;

        if (selectedPlanType === 'anual') {
            planoNomeElement.textContent = 'Premium Anual';
            currentPrice = precoAnual;
        } else {
            planoNomeElement.textContent = 'Premium Mensal';
            currentPrice = precoMensal;
        }
        planoPrecoElement.textContent = `R$${currentPrice.toFixed(2).replace('.', ',')}`;
        totalPrecoElement.textContent = `R$${currentPrice.toFixed(2).replace('.', ',')}`;

        // Update PIX QR code and code (in a real scenario, this would be generated by your backend)
        const pixCodeInput = document.getElementById('pix-code');
        const pixQrCodeImg = document.getElementById('pix-qr-code');
        if (selectedPlanType === 'anual') {
            // Example: a dummy PIX code for annual plan (replace with real logic)
            pixCodeInput.value = '00020126580014BR.GOV.BCB.PIX0136a53266e-2ba4-41d4-8395-502842e22c065204000053039865405' + precoAnual.toFixed(2).replace('.', '') + '5802BR5913Nome Empresa6008BRASILIA62070503***6304CA27';
            pixQrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pixCodeInput.value)}`;
        } else {
            // Example: a dummy PIX code for monthly plan (replace with real logic)
            pixCodeInput.value = '00020126580014BR.GOV.BCB.PIX0136a53266e-2ba4-41d4-8395-502842e22c065204000053039865405' + precoMensal.toFixed(2).replace('.', '') + '5802BR5913Nome Empresa6008BRASILIA62070503***6304CA27';
            pixQrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pixCodeInput.value)}`;
        }
    }

    planTypeRadios.forEach(radio => {
        radio.addEventListener('change', updatePlanDetails);
    });

    // Set initial plan details on load
    updatePlanDetails();

    // --- Lógica de abas de pagamento (Cartão/PIX) ---
    paymentTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetId = button.dataset.tabTarget;

            paymentTabButtons.forEach(btn => btn.classList.remove('active'));
            paymentContents.forEach(content => content.classList.remove('active'));

            button.classList.add('active');
            document.querySelector(targetId).classList.add('active');
        });
    });

    // --- Validação de Formulário Bootstrap ---
    const cardPaymentForm = document.getElementById('card-payment-form');
    cardPaymentForm.addEventListener('submit', function (event) {
        if (!cardPaymentForm.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        } else {
            event.preventDefault(); // Impede o envio real do formulário para simulação
            alert('Pagamento com Cartão simulado com sucesso! Sua assinatura foi ativada.');
            // Em uma aplicação real, aqui você enviaria os dados para um servidor seguro.
            // window.location.href = 'pagina-de-confirmacao.html';
        }
        cardPaymentForm.classList.add('was-validated');
    }, false);

    // --- Lógica do PIX ---
    window.copyPixCode = function() {
        const pixCodeInput = document.getElementById('pix-code');
        pixCodeInput.select();
        pixCodeInput.setSelectionRange(0, 99999); // Para mobile
        document.execCommand('copy');
        alert('Código PIX copiado!');
    };

    document.getElementById('confirm-pix-payment').addEventListener('click', function() {
        alert('Confirmação de pagamento PIX simulada. Sua assinatura será ativada após a compensação.');
        // Em um cenário real, você faria uma requisição ao backend para verificar o status do pagamento PIX.
        // Isso geralmente envolve o backend consultando a API do banco/PSP.
        // window.location.href = 'pagina-de-aguardando-pagamento.html';
    });

    // --- Máscaras para inputs ---
    document.getElementById('numeroCartao').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        let formattedValue = '';
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
                formattedValue += ' ';
            }
            formattedValue += value[i];
        }
        e.target.value = formattedValue;
    });

    document.getElementById('validade').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });

    document.getElementById('cep').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove non-digits
        if (value.length > 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        e.target.value = value;
    });
});